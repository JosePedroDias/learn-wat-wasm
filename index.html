<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    </head>
    <body>
        <script type="module">
            // get args via query string
            const args = location.search ? location.search.substring(1).split(',') : [];

            const wasmFile = args.shift();

            console.log(`wasmFile file: ${wasmFile}`);
            console.log('args:', args);

            if (wasmFile === 'AddInt.wasm') {
                {
                    const watProm = fetch("AddInt.wasm");
                    const obj = await WebAssembly.instantiateStreaming(watProm);

                    const [a, b] = args.map(s => parseInt(s, 10));
                    const { AddInt } =  obj.instance.exports;
                    if (isNaN(a) || isNaN(b)) {
                        throw new Error('needs 2 integer numbers passed in as query string arguments!');
                    }
                    const c = AddInt(a, b);
                    console.log('result:', c);
                }
            } else if (wasmFile === 'HelloWorld.wasm') {
                {
                    const memory = new WebAssembly.Memory ({ initial: 1 });

                    const importObject = {
                        env: {
                            buffer: memory,
                            startStringIndex: 100,
                            PrintString: (startStrIdx, strLen) => {
                                const bytes = new Uint8Array(memory.buffer, startStrIdx, strLen);
                                const strToLog = new TextDecoder('utf8').decode(bytes);
                                console.log(strToLog);
                            }
                        }
                    };

                    const watProm = fetch("HelloWorld.wasm");
                    const obj = await WebAssembly.instantiateStreaming(watProm, importObject);

                    const { HelloWorld } = obj.instance.exports;
                    HelloWorld();
                }
            } else if (wasmFile === 'ForLoop.wasm') {
                {
                    const importObject = {
                        env: {
                            PrintI32: (numI32) => {
                                console.log(numI32);
                            }
                        }
                    };

                    const watProm = fetch("ForLoop.wasm");
                    const obj = await WebAssembly.instantiateStreaming(watProm, importObject);

                    const { ForLoop } =  obj.instance.exports;
                    const [startNum, endNum] = args.map(s => parseInt(s, 10));
                    if (isNaN(startNum) || isNaN(endNum)) {
                        throw new Error('needs 2 integer numbers passed in as query string arguments!');
                    }
                    ForLoop(startNum, endNum);
                }
            } else if (wasmFile === 'Prime.wasm') {
                {
                    const watProm = fetch("Prime.wasm");
                    const obj = await WebAssembly.instantiateStreaming(watProm);

                    const { IsPrime } =  obj.instance.exports;
                    const [n] = args.map(s => parseInt(s, 10));
                    if (isNaN(n)) {
                        throw new Error('needs 1 integer number passed in as query string argument!');
                    }
                    // const isEven = Boolean( EvenCheck(n) ); console.log('is even?', isEven);
                    // const mc = Boolean( MultipleCheck(n, m) ); console.log(n, m, 'is multiple?', mc);
                    const isP = Boolean( IsPrime(n) ); console.log(n, 'is prime?', isP);
                }
            } else {
                alert('expects the wasm file to be provided, followed by the arguments to pass to it');
            }
        </script>
    </body>
</html>
